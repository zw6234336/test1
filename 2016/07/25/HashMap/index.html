<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>java HashMap学习 | 张伟的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">java HashMap学习</h1><a id="logo" href="/.">张伟的博客</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">java HashMap学习</h1><div class="post-meta">Jul 25, 2016<span> | </span><span class="category"><a href="/categories/技术/">技术</a></span></div><div class="post-content"><p><font color="red">简单讲解下HashMap的原理：HashMap基于Hash算法，我们通过put(key,value)存储，get(key)来获取。当传入key时，HashMap会根据key.hashCode()计算出hash值，根据hash值将value保存在bucket里。当计算出的hash值相同时怎么办呢，我们称之为Hash冲突，HashMap的做法是用链表和红黑树存储相同hash值的value。当Hash冲突的个数比较少时，使用链表，否则使用红黑树。</font><br></p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p><img src="http://i.imgur.com/gV60JTP.png" alt=""></p>
<p><strong>属性分析</strong></p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 初始化容量16</span></div><div class="line"><span class="comment">    * The default initial capacity - MUST be a power of two.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 最大容量</span></div><div class="line"><span class="comment">    * The maximum capacity, used if a higher value is implicitly specified</span></div><div class="line"><span class="comment">    * by either of the constructors with arguments.</span></div><div class="line"><span class="comment">    * MUST be a power of two &lt;= 1&lt;&lt;30.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 负载因子	</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment">    * The load factor used when none specified in constructor.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75</span>f;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 当桶上结点大于这个值时链表会转成红黑树</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment">    * The bin count threshold for using a tree rather than list for a</span></div><div class="line"><span class="comment">    * bin.  Bins are converted to trees when adding an element to a</span></div><div class="line"><span class="comment">    * bin with at least this many nodes. The value must be greater</span></div><div class="line"><span class="comment">    * than 2 and should be at least 8 to mesh with assumptions in</span></div><div class="line"><span class="comment">    * tree removal about conversion back to plain bins upon</span></div><div class="line"><span class="comment">    * shrinkage.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 当桶（bucket）上值小于这个值时转成链表</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment">    * The bin count threshold for untreeifying a (split) bin during a</span></div><div class="line"><span class="comment">    * resize operation. Should be less than TREEIFY_THRESHOLD, and at</span></div><div class="line"><span class="comment">    * most 6 to mesh with shrinkage detection under removal.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 桶转换成红黑树对应table最小的值（table是前面的数组）</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment">    * The smallest table capacity for which bins may be treeified.</span></div><div class="line"><span class="comment">    * (Otherwise the table is resized if too many nodes in a bin.)</span></div><div class="line"><span class="comment">    * Should be at least 4 * TREEIFY_THRESHOLD to avoid conflicts</span></div><div class="line"><span class="comment">    * between resizing and treeification thresholds.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 前面的数组存的总是2的倍数</span></div><div class="line"><span class="comment">    * The table, initialized on first use, and resized as</span></div><div class="line"><span class="comment">    * necessary. When allocated, length is always a power of two.</span></div><div class="line"><span class="comment">    * (We also tolerate length zero in some operations to allow</span></div><div class="line"><span class="comment">    * bootstrapping mechanics that are currently not needed.)</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   transient Node&lt;K,V&gt;[] table;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line"><span class="comment"> * 这个是用来存储数据的</span></div><div class="line"><span class="comment">    * Holds cached entrySet(). Note that AbstractMap fields are used</span></div><div class="line"><span class="comment">    * for keySet() and values().</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   transient Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 当容量*负载因子超过临界值时，会进行重置</span></div><div class="line"><span class="comment">    * The next size value at which to resize (capacity * load factor).</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@serial</span></span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">int</span> threshold;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 得到当前容量最接近的2的倍数</span></div><div class="line"><span class="comment">    * Returns a power of two size for the given target capacity.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> tableSizeFor(<span class="keyword">int</span> cap) &#123;</div><div class="line">       <span class="keyword">int</span> n = cap - <span class="number">1</span>;</div><div class="line">       n |= n &gt;&gt;&gt; <span class="number">1</span>;</div><div class="line">       n |= n &gt;&gt;&gt; <span class="number">2</span>;</div><div class="line">       n |= n &gt;&gt;&gt; <span class="number">4</span>;</div><div class="line">       n |= n &gt;&gt;&gt; <span class="number">8</span>;</div><div class="line">       n |= n &gt;&gt;&gt; <span class="number">16</span>;</div><div class="line">       <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="重要内部类Node"><a href="#重要内部类Node" class="headerlink" title="重要内部类Node"></a>重要内部类Node</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">    * Basic hash bin node, used for most entries.  (See below for</span></div><div class="line"><span class="comment">    * TreeNode subclass, and in LinkedHashMap for its Entry subclass.)</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;</div><div class="line">       <span class="keyword">final</span> <span class="built_in">int</span> hash;</div><div class="line">       <span class="keyword">final</span> K <span class="built_in">key</span>;</div><div class="line">       V value;</div><div class="line">       Node&lt;K,V&gt; next;</div><div class="line"></div><div class="line">       Node(<span class="built_in">int</span> hash, K <span class="built_in">key</span>, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">           <span class="keyword">this</span>.hash = hash;</div><div class="line">           <span class="keyword">this</span>.<span class="built_in">key</span> = <span class="built_in">key</span>;</div><div class="line">           <span class="keyword">this</span>.value = value;</div><div class="line">           <span class="keyword">this</span>.next = next;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> K getKey()        &#123; <span class="keyword">return</span> <span class="built_in">key</span>; &#125;</div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> V getValue()      &#123; <span class="keyword">return</span> value; &#125;</div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">String</span> toString() &#123; <span class="keyword">return</span> <span class="built_in">key</span> + <span class="string">"="</span> + value; &#125;</div><div class="line"></div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> <span class="built_in">int</span> hashCode() &#123;</div><div class="line">           <span class="keyword">return</span> Objects.hashCode(<span class="built_in">key</span>) ^ Objects.hashCode(value);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> V setValue(V newValue) &#123;</div><div class="line">           V oldValue = value;</div><div class="line">           value = newValue;</div><div class="line">           <span class="keyword">return</span> oldValue;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">public</span> <span class="keyword">final</span> <span class="built_in">boolean</span> equals(<span class="keyword">Object</span> o) &#123;</div><div class="line">           <span class="keyword">if</span> (o == <span class="keyword">this</span>)</div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           <span class="keyword">if</span> (o <span class="keyword">instanceof</span> Map.Entry) &#123;</div><div class="line">               Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</div><div class="line">               <span class="keyword">if</span> (Objects.equals(<span class="built_in">key</span>, e.getKey()) &amp;&amp;</div><div class="line">                   Objects.equals(value, e.getValue()))</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="重要内部类TreeNode"><a href="#重要内部类TreeNode" class="headerlink" title="重要内部类TreeNode"></a>重要内部类TreeNode</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div></pre></td><td class="code"><pre><div class="line"> static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123;</div><div class="line">       TreeNode&lt;K,V&gt; parent;  // red-black tree links</div><div class="line">       TreeNode&lt;K,V&gt; left;</div><div class="line">       TreeNode&lt;K,V&gt; right;</div><div class="line">       TreeNode&lt;K,V&gt; prev;    // needed to unlink next upon deletion</div><div class="line">       boolean red;</div><div class="line">       TreeNode(int hash, K key, V val, Node&lt;K,V&gt; next) &#123;</div><div class="line">           super(hash, key, val, next);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Returns root of tree containing this node.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final TreeNode&lt;K,V&gt; root() &#123;</div><div class="line">           for (TreeNode&lt;K,V&gt; <span class="attr">r</span> = this, p;;) &#123;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">p</span> = r.parent) == <span class="literal">null</span>)</div><div class="line">                   return r;</div><div class="line">               <span class="attr">r</span> = p;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Ensures that the given root is the first node of its bin.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       static &lt;K,V&gt; void moveRootToFront(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root) &#123;</div><div class="line">           int n;</div><div class="line">           <span class="keyword">if</span> (root != <span class="literal">null</span> &amp;&amp; tab != <span class="literal">null</span> &amp;&amp; (<span class="attr">n</span> = tab.length) &gt; <span class="number">0</span>) &#123;</div><div class="line">               int <span class="attr">index</span> = (n - <span class="number">1</span>) &amp; root.hash;</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">first</span> = (TreeNode&lt;K,V&gt;)tab[index];</div><div class="line">               <span class="keyword">if</span> (root != first) &#123;</div><div class="line">                   Node&lt;K,V&gt; rn;</div><div class="line">                   tab[index] = root;</div><div class="line">                   TreeNode&lt;K,V&gt; <span class="attr">rp</span> = root.prev;</div><div class="line">                   <span class="keyword">if</span> ((<span class="attr">rn</span> = root.next) != <span class="literal">null</span>)</div><div class="line">                       ((TreeNode&lt;K,V&gt;)rn).<span class="attr">prev</span> = rp;</div><div class="line">                   <span class="keyword">if</span> (rp != <span class="literal">null</span>)</div><div class="line">                       rp.<span class="attr">next</span> = rn;</div><div class="line">                   <span class="keyword">if</span> (first != <span class="literal">null</span>)</div><div class="line">                       first.<span class="attr">prev</span> = root;</div><div class="line">                   root.<span class="attr">next</span> = first;</div><div class="line">                   root.<span class="attr">prev</span> = <span class="literal">null</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">assert</span> checkInvariants(root);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Finds the node starting at root p with the given hash and key.</span></div><div class="line"><span class="comment">        * The kc argument caches comparableClassFor(key) upon first use</span></div><div class="line"><span class="comment">        * comparing keys.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final TreeNode&lt;K,V&gt; find(int h, Object k, Class&lt;?&gt; kc) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">p</span> = this;</div><div class="line">           do &#123;</div><div class="line">               int ph, dir; K pk;</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">pl</span> = p.left, <span class="attr">pr</span> = p.right, q;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">ph</span> = p.hash) &gt; h)</div><div class="line">                   <span class="attr">p</span> = pl;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</div><div class="line">                   <span class="attr">p</span> = pr;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">pk</span> = p.key) == k || (k != <span class="literal">null</span> &amp;&amp; k.equals(pk)))</div><div class="line">                   return p;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">pl</span> == <span class="literal">null</span>)</div><div class="line">                   <span class="attr">p</span> = pr;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">pr</span> == <span class="literal">null</span>)</div><div class="line">                   <span class="attr">p</span> = pl;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="literal">null</span> ||</div><div class="line">                         (<span class="attr">kc</span> = comparableClassFor(k)) != <span class="literal">null</span>) &amp;&amp;</div><div class="line">                        (<span class="attr">dir</span> = compareComparables(kc, k, pk)) != <span class="number">0</span>)</div><div class="line">                   <span class="attr">p</span> = (dir &lt; <span class="number">0</span>) ? pl : pr;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">q</span> = pr.find(h, k, kc)) != <span class="literal">null</span>)</div><div class="line">                   return q;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   <span class="attr">p</span> = pl;</div><div class="line">           &#125; while (p != <span class="literal">null</span>);</div><div class="line">           return <span class="literal">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Calls find for root node.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final TreeNode&lt;K,V&gt; getTreeNode(int h, Object k) &#123;</div><div class="line">           return ((parent != <span class="literal">null</span>) ? root() : this).find(h, k, <span class="literal">null</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Tie-breaking utility for ordering insertions when equal</span></div><div class="line"><span class="comment">        * hashCodes and non-comparable. We don't require a total</span></div><div class="line"><span class="comment">        * order, just a consistent insertion rule to maintain</span></div><div class="line"><span class="comment">        * equivalence across rebalancings. Tie-breaking further than</span></div><div class="line"><span class="comment">        * necessary simplifies testing a bit.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       static int tieBreakOrder(Object a, Object b) &#123;</div><div class="line">           int d;</div><div class="line">           <span class="keyword">if</span> (<span class="attr">a</span> == <span class="literal">null</span> || <span class="attr">b</span> == <span class="literal">null</span> ||</div><div class="line">               (<span class="attr">d</span> = a.getClass().getName().</div><div class="line">                compareTo(b.getClass().getName())) == <span class="number">0</span>)</div><div class="line">               <span class="attr">d</span> = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</div><div class="line">                    -<span class="number">1</span> : <span class="number">1</span>);</div><div class="line">           return d;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Forms tree of the nodes linked from this node.</span></div><div class="line"><span class="comment">        * @return root of tree</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final void treeify(Node&lt;K,V&gt;[] tab) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">root</span> = <span class="literal">null</span>;</div><div class="line">           for (TreeNode&lt;K,V&gt; <span class="attr">x</span> = this, next; x != <span class="literal">null</span>; <span class="attr">x</span> = next) &#123;</div><div class="line">               <span class="attr">next</span> = (TreeNode&lt;K,V&gt;)x.next;</div><div class="line">               x.<span class="attr">left</span> = x.<span class="attr">right</span> = <span class="literal">null</span>;</div><div class="line">               <span class="keyword">if</span> (<span class="attr">root</span> == <span class="literal">null</span>) &#123;</div><div class="line">                   x.<span class="attr">parent</span> = <span class="literal">null</span>;</div><div class="line">                   x.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                   <span class="attr">root</span> = x;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   K <span class="attr">k</span> = x.key;</div><div class="line">                   int <span class="attr">h</span> = x.hash;</div><div class="line">                   Class&lt;?&gt; <span class="attr">kc</span> = <span class="literal">null</span>;</div><div class="line">                   for (TreeNode&lt;K,V&gt; <span class="attr">p</span> = root;;) &#123;</div><div class="line">                       int dir, ph;</div><div class="line">                       K <span class="attr">pk</span> = p.key;</div><div class="line">                       <span class="keyword">if</span> ((<span class="attr">ph</span> = p.hash) &gt; h)</div><div class="line">                           <span class="attr">dir</span> = -<span class="number">1</span>;</div><div class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</div><div class="line">                           <span class="attr">dir</span> = <span class="number">1</span>;</div><div class="line">                       <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">kc</span> == <span class="literal">null</span> &amp;&amp;</div><div class="line">                                 (<span class="attr">kc</span> = comparableClassFor(k)) == <span class="literal">null</span>) ||</div><div class="line">                                (<span class="attr">dir</span> = compareComparables(kc, k, pk)) == <span class="number">0</span>)</div><div class="line">                           <span class="attr">dir</span> = tieBreakOrder(k, pk);</div><div class="line"></div><div class="line">                       TreeNode&lt;K,V&gt; <span class="attr">xp</span> = p;</div><div class="line">                       <span class="keyword">if</span> ((<span class="attr">p</span> = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="literal">null</span>) &#123;</div><div class="line">                           x.<span class="attr">parent</span> = xp;</div><div class="line">                           <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</div><div class="line">                               xp.<span class="attr">left</span> = x;</div><div class="line">                           <span class="keyword">else</span></div><div class="line">                               xp.<span class="attr">right</span> = x;</div><div class="line">                           <span class="attr">root</span> = balanceInsertion(root, x);</div><div class="line">                           break;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           moveRootToFront(tab, root);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Returns a list of non-TreeNodes replacing those linked from</span></div><div class="line"><span class="comment">        * this node.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final Node&lt;K,V&gt; untreeify(HashMap&lt;K,V&gt; <span class="built_in">map</span>) &#123;</div><div class="line">           Node&lt;K,V&gt; <span class="attr">hd</span> = <span class="literal">null</span>, <span class="attr">tl</span> = <span class="literal">null</span>;</div><div class="line">           for (Node&lt;K,V&gt; <span class="attr">q</span> = this; q != <span class="literal">null</span>; <span class="attr">q</span> = q.next) &#123;</div><div class="line">               Node&lt;K,V&gt; <span class="attr">p</span> = <span class="built_in">map</span>.replacementNode(q, <span class="literal">null</span>);</div><div class="line">               <span class="keyword">if</span> (<span class="attr">tl</span> == <span class="literal">null</span>)</div><div class="line">                   <span class="attr">hd</span> = p;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   tl.<span class="attr">next</span> = p;</div><div class="line">               <span class="attr">tl</span> = p;</div><div class="line">           &#125;</div><div class="line">           return hd;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Tree version of putVal.</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final TreeNode&lt;K,V&gt; putTreeVal(HashMap&lt;K,V&gt; <span class="built_in">map</span>, Node&lt;K,V&gt;[] tab,</div><div class="line">                                      int h, K k, V v) &#123;</div><div class="line">           Class&lt;?&gt; <span class="attr">kc</span> = <span class="literal">null</span>;</div><div class="line">           boolean <span class="attr">searched</span> = <span class="literal">false</span>;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">root</span> = (parent != <span class="literal">null</span>) ? root() : this;</div><div class="line">           for (TreeNode&lt;K,V&gt; <span class="attr">p</span> = root;;) &#123;</div><div class="line">               int dir, ph; K pk;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">ph</span> = p.hash) &gt; h)</div><div class="line">                   <span class="attr">dir</span> = -<span class="number">1</span>;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</div><div class="line">                   <span class="attr">dir</span> = <span class="number">1</span>;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">pk</span> = p.key) == k || (k != <span class="literal">null</span> &amp;&amp; k.equals(pk)))</div><div class="line">                   return p;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">kc</span> == <span class="literal">null</span> &amp;&amp;</div><div class="line">                         (<span class="attr">kc</span> = comparableClassFor(k)) == <span class="literal">null</span>) ||</div><div class="line">                        (<span class="attr">dir</span> = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (!searched) &#123;</div><div class="line">                       TreeNode&lt;K,V&gt; q, ch;</div><div class="line">                       <span class="attr">searched</span> = <span class="literal">true</span>;</div><div class="line">                       <span class="keyword">if</span> (((<span class="attr">ch</span> = p.left) != <span class="literal">null</span> &amp;&amp;</div><div class="line">                            (<span class="attr">q</span> = ch.find(h, k, kc)) != <span class="literal">null</span>) ||</div><div class="line">                           ((<span class="attr">ch</span> = p.right) != <span class="literal">null</span> &amp;&amp;</div><div class="line">                            (<span class="attr">q</span> = ch.find(h, k, kc)) != <span class="literal">null</span>))</div><div class="line">                           return q;</div><div class="line">                   &#125;</div><div class="line">                   <span class="attr">dir</span> = tieBreakOrder(k, pk);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">xp</span> = p;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">p</span> = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="literal">null</span>) &#123;</div><div class="line">                   Node&lt;K,V&gt; <span class="attr">xpn</span> = xp.next;</div><div class="line">                   TreeNode&lt;K,V&gt; <span class="attr">x</span> = <span class="built_in">map</span>.newTreeNode(h, k, v, xpn);</div><div class="line">                   <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</div><div class="line">                       xp.<span class="attr">left</span> = x;</div><div class="line">                   <span class="keyword">else</span></div><div class="line">                       xp.<span class="attr">right</span> = x;</div><div class="line">                   xp.<span class="attr">next</span> = x;</div><div class="line">                   x.<span class="attr">parent</span> = x.<span class="attr">prev</span> = xp;</div><div class="line">                   <span class="keyword">if</span> (xpn != <span class="literal">null</span>)</div><div class="line">                       ((TreeNode&lt;K,V&gt;)xpn).<span class="attr">prev</span> = x;</div><div class="line">                   moveRootToFront(tab, balanceInsertion(root, x));</div><div class="line">                   return <span class="literal">null</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Removes the given node, that must be present before this call.</span></div><div class="line"><span class="comment">        * This is messier than typical red-black deletion code because we</span></div><div class="line"><span class="comment">        * cannot swap the contents of an interior node with a leaf</span></div><div class="line"><span class="comment">        * successor that is pinned by "next" pointers that are accessible</span></div><div class="line"><span class="comment">        * independently during traversal. So instead we swap the tree</span></div><div class="line"><span class="comment">        * linkages. If the current tree appears to have too few nodes,</span></div><div class="line"><span class="comment">        * the bin is converted back to a plain bin. (The test triggers</span></div><div class="line"><span class="comment">        * somewhere between 2 and 6 nodes, depending on tree structure).</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final void removeTreeNode(HashMap&lt;K,V&gt; <span class="built_in">map</span>, Node&lt;K,V&gt;[] tab,</div><div class="line">                                 boolean movable) &#123;</div><div class="line">           int n;</div><div class="line">           <span class="keyword">if</span> (<span class="attr">tab</span> == <span class="literal">null</span> || (<span class="attr">n</span> = tab.length) == <span class="number">0</span>)</div><div class="line">               return;</div><div class="line">           int <span class="attr">index</span> = (n - <span class="number">1</span>) &amp; hash;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">first</span> = (TreeNode&lt;K,V&gt;)tab[index], <span class="attr">root</span> = first, rl;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">succ</span> = (TreeNode&lt;K,V&gt;)next, <span class="attr">pred</span> = prev;</div><div class="line">           <span class="keyword">if</span> (<span class="attr">pred</span> == <span class="literal">null</span>)</div><div class="line">               tab[index] = <span class="attr">first</span> = succ;</div><div class="line">           <span class="keyword">else</span></div><div class="line">               pred.<span class="attr">next</span> = succ;</div><div class="line">           <span class="keyword">if</span> (succ != <span class="literal">null</span>)</div><div class="line">               succ.<span class="attr">prev</span> = pred;</div><div class="line">           <span class="keyword">if</span> (<span class="attr">first</span> == <span class="literal">null</span>)</div><div class="line">               return;</div><div class="line">           <span class="keyword">if</span> (root.parent != <span class="literal">null</span>)</div><div class="line">               <span class="attr">root</span> = root.root();</div><div class="line">           <span class="keyword">if</span> (<span class="attr">root</span> == <span class="literal">null</span> || root.<span class="attr">right</span> == <span class="literal">null</span> ||</div><div class="line">               (<span class="attr">rl</span> = root.left) == <span class="literal">null</span> || rl.<span class="attr">left</span> == <span class="literal">null</span>) &#123;</div><div class="line">               tab[index] = first.untreeify(<span class="built_in">map</span>);  // too small</div><div class="line">               return;</div><div class="line">           &#125;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">p</span> = this, <span class="attr">pl</span> = left, <span class="attr">pr</span> = right, replacement;</div><div class="line">           <span class="keyword">if</span> (pl != <span class="literal">null</span> &amp;&amp; pr != <span class="literal">null</span>) &#123;</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">s</span> = pr, sl;</div><div class="line">               while ((<span class="attr">sl</span> = s.left) != <span class="literal">null</span>) // find successor</div><div class="line">                   <span class="attr">s</span> = sl;</div><div class="line">               boolean <span class="attr">c</span> = s.red; s.<span class="attr">red</span> = p.red; p.<span class="attr">red</span> = c; // swap colors</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">sr</span> = s.right;</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">pp</span> = p.parent;</div><div class="line">               <span class="keyword">if</span> (<span class="attr">s</span> == pr) &#123; // p was s's direct parent</div><div class="line">                   p.<span class="attr">parent</span> = s;</div><div class="line">                   s.<span class="attr">right</span> = p;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   TreeNode&lt;K,V&gt; <span class="attr">sp</span> = s.parent;</div><div class="line">                   <span class="keyword">if</span> ((p.<span class="attr">parent</span> = sp) != <span class="literal">null</span>) &#123;</div><div class="line">                       <span class="keyword">if</span> (<span class="attr">s</span> == sp.left)</div><div class="line">                           sp.<span class="attr">left</span> = p;</div><div class="line">                       <span class="keyword">else</span></div><div class="line">                           sp.<span class="attr">right</span> = p;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> ((s.<span class="attr">right</span> = pr) != <span class="literal">null</span>)</div><div class="line">                       pr.<span class="attr">parent</span> = s;</div><div class="line">               &#125;</div><div class="line">               p.<span class="attr">left</span> = <span class="literal">null</span>;</div><div class="line">               <span class="keyword">if</span> ((p.<span class="attr">right</span> = sr) != <span class="literal">null</span>)</div><div class="line">                   sr.<span class="attr">parent</span> = p;</div><div class="line">               <span class="keyword">if</span> ((s.<span class="attr">left</span> = pl) != <span class="literal">null</span>)</div><div class="line">                   pl.<span class="attr">parent</span> = s;</div><div class="line">               <span class="keyword">if</span> ((s.<span class="attr">parent</span> = pp) == <span class="literal">null</span>)</div><div class="line">                   <span class="attr">root</span> = s;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">p</span> == pp.left)</div><div class="line">                   pp.<span class="attr">left</span> = s;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   pp.<span class="attr">right</span> = s;</div><div class="line">               <span class="keyword">if</span> (sr != <span class="literal">null</span>)</div><div class="line">                   <span class="attr">replacement</span> = sr;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   <span class="attr">replacement</span> = p;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (pl != <span class="literal">null</span>)</div><div class="line">               <span class="attr">replacement</span> = pl;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (pr != <span class="literal">null</span>)</div><div class="line">               <span class="attr">replacement</span> = pr;</div><div class="line">           <span class="keyword">else</span></div><div class="line">               <span class="attr">replacement</span> = p;</div><div class="line">           <span class="keyword">if</span> (replacement != p) &#123;</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">pp</span> = replacement.<span class="attr">parent</span> = p.parent;</div><div class="line">               <span class="keyword">if</span> (<span class="attr">pp</span> == <span class="literal">null</span>)</div><div class="line">                   <span class="attr">root</span> = replacement;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">p</span> == pp.left)</div><div class="line">                   pp.<span class="attr">left</span> = replacement;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   pp.<span class="attr">right</span> = replacement;</div><div class="line">               p.<span class="attr">left</span> = p.<span class="attr">right</span> = p.<span class="attr">parent</span> = <span class="literal">null</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">r</span> = p.red ? root : balanceDeletion(root, replacement);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (<span class="attr">replacement</span> == p) &#123;  // detach</div><div class="line">               TreeNode&lt;K,V&gt; <span class="attr">pp</span> = p.parent;</div><div class="line">               p.<span class="attr">parent</span> = <span class="literal">null</span>;</div><div class="line">               <span class="keyword">if</span> (pp != <span class="literal">null</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (<span class="attr">p</span> == pp.left)</div><div class="line">                       pp.<span class="attr">left</span> = <span class="literal">null</span>;</div><div class="line">                   <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">p</span> == pp.right)</div><div class="line">                       pp.<span class="attr">right</span> = <span class="literal">null</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (movable)</div><div class="line">               moveRootToFront(tab, r);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Splits nodes in a tree bin into lower and upper tree bins,</span></div><div class="line"><span class="comment">        * or untreeifies if now too small. Called only from resize;</span></div><div class="line"><span class="comment">        * see above discussion about split bits and indices.</span></div><div class="line"><span class="comment">        *</span></div><div class="line"><span class="comment">        * @param map the map</span></div><div class="line"><span class="comment">        * @param tab the table for recording bin heads</span></div><div class="line"><span class="comment">        * @param index the index of the table being split</span></div><div class="line"><span class="comment">        * @param bit the bit of hash to split on</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       final void split(HashMap&lt;K,V&gt; <span class="built_in">map</span>, Node&lt;K,V&gt;[] tab, int index, int bit) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">b</span> = this;</div><div class="line">           // Relink into lo <span class="literal">and</span> hi lists, preserving order</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">loHead</span> = <span class="literal">null</span>, <span class="attr">loTail</span> = <span class="literal">null</span>;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">hiHead</span> = <span class="literal">null</span>, <span class="attr">hiTail</span> = <span class="literal">null</span>;</div><div class="line">           int <span class="attr">lc</span> = <span class="number">0</span>, <span class="attr">hc</span> = <span class="number">0</span>;</div><div class="line">           for (TreeNode&lt;K,V&gt; <span class="attr">e</span> = b, next; e != <span class="literal">null</span>; <span class="attr">e</span> = next) &#123;</div><div class="line">               <span class="attr">next</span> = (TreeNode&lt;K,V&gt;)e.next;</div><div class="line">               e.<span class="attr">next</span> = <span class="literal">null</span>;</div><div class="line">               <span class="keyword">if</span> ((e.hash &amp; bit) == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> ((e.<span class="attr">prev</span> = loTail) == <span class="literal">null</span>)</div><div class="line">                       <span class="attr">loHead</span> = e;</div><div class="line">                   <span class="keyword">else</span></div><div class="line">                       loTail.<span class="attr">next</span> = e;</div><div class="line">                   <span class="attr">loTail</span> = e;</div><div class="line">                   ++lc;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">if</span> ((e.<span class="attr">prev</span> = hiTail) == <span class="literal">null</span>)</div><div class="line">                       <span class="attr">hiHead</span> = e;</div><div class="line">                   <span class="keyword">else</span></div><div class="line">                       hiTail.<span class="attr">next</span> = e;</div><div class="line">                   <span class="attr">hiTail</span> = e;</div><div class="line">                   ++hc;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (loHead != <span class="literal">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</div><div class="line">                   tab[index] = loHead.untreeify(<span class="built_in">map</span>);</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   tab[index] = loHead;</div><div class="line">                   <span class="keyword">if</span> (hiHead != <span class="literal">null</span>) // (<span class="keyword">else</span> is already treeified)</div><div class="line">                       loHead.treeify(tab);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (hiHead != <span class="literal">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (hc &lt;= UNTREEIFY_THRESHOLD)</div><div class="line">                   tab[index + bit] = hiHead.untreeify(<span class="built_in">map</span>);</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   tab[index + bit] = hiHead;</div><div class="line">                   <span class="keyword">if</span> (loHead != <span class="literal">null</span>)</div><div class="line">                       hiHead.treeify(tab);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/* ------------------------------------------------------------ */</span></div><div class="line">       // Red-black tree methods, all adapted from CLR</div><div class="line"></div><div class="line">       static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateLeft(TreeNode&lt;K,V&gt; root,</div><div class="line">                                             TreeNode&lt;K,V&gt; p) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; r, pp, rl;</div><div class="line">           <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (<span class="attr">r</span> = p.right) != <span class="literal">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">rl</span> = p.<span class="attr">right</span> = r.left) != <span class="literal">null</span>)</div><div class="line">                   rl.<span class="attr">parent</span> = p;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">pp</span> = r.<span class="attr">parent</span> = p.parent) == <span class="literal">null</span>)</div><div class="line">                   (<span class="attr">root</span> = r).<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (pp.<span class="attr">left</span> == p)</div><div class="line">                   pp.<span class="attr">left</span> = r;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   pp.<span class="attr">right</span> = r;</div><div class="line">               r.<span class="attr">left</span> = p;</div><div class="line">               p.<span class="attr">parent</span> = r;</div><div class="line">           &#125;</div><div class="line">           return root;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       static &lt;K,V&gt; TreeNode&lt;K,V&gt; rotateRight(TreeNode&lt;K,V&gt; root,</div><div class="line">                                              TreeNode&lt;K,V&gt; p) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; l, pp, lr;</div><div class="line">           <span class="keyword">if</span> (p != <span class="literal">null</span> &amp;&amp; (<span class="attr">l</span> = p.left) != <span class="literal">null</span>) &#123;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">lr</span> = p.<span class="attr">left</span> = l.right) != <span class="literal">null</span>)</div><div class="line">                   lr.<span class="attr">parent</span> = p;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">pp</span> = l.<span class="attr">parent</span> = p.parent) == <span class="literal">null</span>)</div><div class="line">                   (<span class="attr">root</span> = l).<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (pp.<span class="attr">right</span> == p)</div><div class="line">                   pp.<span class="attr">right</span> = l;</div><div class="line">               <span class="keyword">else</span></div><div class="line">                   pp.<span class="attr">left</span> = l;</div><div class="line">               l.<span class="attr">right</span> = p;</div><div class="line">               p.<span class="attr">parent</span> = l;</div><div class="line">           &#125;</div><div class="line">           return root;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceInsertion(TreeNode&lt;K,V&gt; root,</div><div class="line">                                                   TreeNode&lt;K,V&gt; x) &#123;</div><div class="line">           x.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">           for (TreeNode&lt;K,V&gt; xp, xpp, xppl, xppr;;) &#123;</div><div class="line">               <span class="keyword">if</span> ((<span class="attr">xp</span> = x.parent) == <span class="literal">null</span>) &#123;</div><div class="line">                   x.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                   return x;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (!xp.red || (<span class="attr">xpp</span> = xp.parent) == <span class="literal">null</span>)</div><div class="line">                   return root;</div><div class="line">               <span class="keyword">if</span> (<span class="attr">xp</span> == (<span class="attr">xppl</span> = xpp.left)) &#123;</div><div class="line">                   <span class="keyword">if</span> ((<span class="attr">xppr</span> = xpp.right) != <span class="literal">null</span> &amp;&amp; xppr.red) &#123;</div><div class="line">                       xppr.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xpp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                       <span class="attr">x</span> = xpp;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">if</span> (<span class="attr">x</span> == xp.right) &#123;</div><div class="line">                           <span class="attr">root</span> = rotateLeft(root, <span class="attr">x</span> = xp);</div><div class="line">                           <span class="attr">xpp</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ? <span class="literal">null</span> : xp.parent;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">if</span> (xp != <span class="literal">null</span>) &#123;</div><div class="line">                           xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                           <span class="keyword">if</span> (xpp != <span class="literal">null</span>) &#123;</div><div class="line">                               xpp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                               <span class="attr">root</span> = rotateRight(root, xpp);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">if</span> (xppl != <span class="literal">null</span> &amp;&amp; xppl.red) &#123;</div><div class="line">                       xppl.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xpp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                       <span class="attr">x</span> = xpp;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">else</span> &#123;</div><div class="line">                       <span class="keyword">if</span> (<span class="attr">x</span> == xp.left) &#123;</div><div class="line">                           <span class="attr">root</span> = rotateRight(root, <span class="attr">x</span> = xp);</div><div class="line">                           <span class="attr">xpp</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ? <span class="literal">null</span> : xp.parent;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">if</span> (xp != <span class="literal">null</span>) &#123;</div><div class="line">                           xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                           <span class="keyword">if</span> (xpp != <span class="literal">null</span>) &#123;</div><div class="line">                               xpp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                               <span class="attr">root</span> = rotateLeft(root, xpp);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       static &lt;K,V&gt; TreeNode&lt;K,V&gt; balanceDeletion(TreeNode&lt;K,V&gt; root,</div><div class="line">                                                  TreeNode&lt;K,V&gt; x) &#123;</div><div class="line">           for (TreeNode&lt;K,V&gt; xp, xpl, xpr;;)  &#123;</div><div class="line">               <span class="keyword">if</span> (<span class="attr">x</span> == <span class="literal">null</span> || <span class="attr">x</span> == root)</div><div class="line">                   return root;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">xp</span> = x.parent) == <span class="literal">null</span>) &#123;</div><div class="line">                   x.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                   return x;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (x.red) &#123;</div><div class="line">                   x.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                   return root;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="attr">xpl</span> = xp.left) == x) &#123;</div><div class="line">                   <span class="keyword">if</span> ((<span class="attr">xpr</span> = xp.right) != <span class="literal">null</span> &amp;&amp; xpr.red) &#123;</div><div class="line">                       xpr.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                       <span class="attr">root</span> = rotateLeft(root, xp);</div><div class="line">                       <span class="attr">xpr</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ? <span class="literal">null</span> : xp.right;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (<span class="attr">xpr</span> == <span class="literal">null</span>)</div><div class="line">                       <span class="attr">x</span> = xp;</div><div class="line">                   <span class="keyword">else</span> &#123;</div><div class="line">                       TreeNode&lt;K,V&gt; <span class="attr">sl</span> = xpr.left, <span class="attr">sr</span> = xpr.right;</div><div class="line">                       <span class="keyword">if</span> ((<span class="attr">sr</span> == <span class="literal">null</span> || !sr.red) &amp;&amp;</div><div class="line">                           (<span class="attr">sl</span> == <span class="literal">null</span> || !sl.red)) &#123;</div><div class="line">                           xpr.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                           <span class="attr">x</span> = xp;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (<span class="attr">sr</span> == <span class="literal">null</span> || !sr.red) &#123;</div><div class="line">                               <span class="keyword">if</span> (sl != <span class="literal">null</span>)</div><div class="line">                                   sl.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                               xpr.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                               <span class="attr">root</span> = rotateRight(root, xpr);</div><div class="line">                               <span class="attr">xpr</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ?</div><div class="line">                                   <span class="literal">null</span> : xp.right;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">if</span> (xpr != <span class="literal">null</span>) &#123;</div><div class="line">                               xpr.<span class="attr">red</span> = (<span class="attr">xp</span> == <span class="literal">null</span>) ? <span class="literal">false</span> : xp.red;</div><div class="line">                               <span class="keyword">if</span> ((<span class="attr">sr</span> = xpr.right) != <span class="literal">null</span>)</div><div class="line">                                   sr.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">if</span> (xp != <span class="literal">null</span>) &#123;</div><div class="line">                               xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                               <span class="attr">root</span> = rotateLeft(root, xp);</div><div class="line">                           &#125;</div><div class="line">                           <span class="attr">x</span> = root;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">else</span> &#123; // symmetric</div><div class="line">                   <span class="keyword">if</span> (xpl != <span class="literal">null</span> &amp;&amp; xpl.red) &#123;</div><div class="line">                       xpl.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                       xp.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                       <span class="attr">root</span> = rotateRight(root, xp);</div><div class="line">                       <span class="attr">xpl</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ? <span class="literal">null</span> : xp.left;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (<span class="attr">xpl</span> == <span class="literal">null</span>)</div><div class="line">                       <span class="attr">x</span> = xp;</div><div class="line">                   <span class="keyword">else</span> &#123;</div><div class="line">                       TreeNode&lt;K,V&gt; <span class="attr">sl</span> = xpl.left, <span class="attr">sr</span> = xpl.right;</div><div class="line">                       <span class="keyword">if</span> ((<span class="attr">sl</span> == <span class="literal">null</span> || !sl.red) &amp;&amp;</div><div class="line">                           (<span class="attr">sr</span> == <span class="literal">null</span> || !sr.red)) &#123;</div><div class="line">                           xpl.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                           <span class="attr">x</span> = xp;</div><div class="line">                       &#125;</div><div class="line">                       <span class="keyword">else</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (<span class="attr">sl</span> == <span class="literal">null</span> || !sl.red) &#123;</div><div class="line">                               <span class="keyword">if</span> (sr != <span class="literal">null</span>)</div><div class="line">                                   sr.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                               xpl.<span class="attr">red</span> = <span class="literal">true</span>;</div><div class="line">                               <span class="attr">root</span> = rotateLeft(root, xpl);</div><div class="line">                               <span class="attr">xpl</span> = (<span class="attr">xp</span> = x.parent) == <span class="literal">null</span> ?</div><div class="line">                                   <span class="literal">null</span> : xp.left;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">if</span> (xpl != <span class="literal">null</span>) &#123;</div><div class="line">                               xpl.<span class="attr">red</span> = (<span class="attr">xp</span> == <span class="literal">null</span>) ? <span class="literal">false</span> : xp.red;</div><div class="line">                               <span class="keyword">if</span> ((<span class="attr">sl</span> = xpl.left) != <span class="literal">null</span>)</div><div class="line">                                   sl.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">if</span> (xp != <span class="literal">null</span>) &#123;</div><div class="line">                               xp.<span class="attr">red</span> = <span class="literal">false</span>;</div><div class="line">                               <span class="attr">root</span> = rotateRight(root, xp);</div><div class="line">                           &#125;</div><div class="line">                           <span class="attr">x</span> = root;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">/**</span></div><div class="line"><span class="comment">        * Recursive invariant check</span></div><div class="line"><span class="comment">        */</span></div><div class="line">       static &lt;K,V&gt; boolean checkInvariants(TreeNode&lt;K,V&gt; t) &#123;</div><div class="line">           TreeNode&lt;K,V&gt; <span class="attr">tp</span> = t.parent, <span class="attr">tl</span> = t.left, <span class="attr">tr</span> = t.right,</div><div class="line">               <span class="attr">tb</span> = t.prev, <span class="attr">tn</span> = (TreeNode&lt;K,V&gt;)t.next;</div><div class="line">           <span class="keyword">if</span> (tb != <span class="literal">null</span> &amp;&amp; tb.next != t)</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tn != <span class="literal">null</span> &amp;&amp; tn.prev != t)</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tp != <span class="literal">null</span> &amp;&amp; t != tp.left &amp;&amp; t != tp.right)</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tl != <span class="literal">null</span> &amp;&amp; (tl.parent != t || tl.hash &gt; t.hash))</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tr != <span class="literal">null</span> &amp;&amp; (tr.parent != t || tr.hash &lt; t.hash))</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (t.red &amp;&amp; tl != <span class="literal">null</span> &amp;&amp; tl.red &amp;&amp; tr != <span class="literal">null</span> &amp;&amp; tr.red)</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tl != <span class="literal">null</span> &amp;&amp; !checkInvariants(tl))</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           <span class="keyword">if</span> (tr != <span class="literal">null</span> &amp;&amp; !checkInvariants(tr))</div><div class="line">               return <span class="literal">false</span>;</div><div class="line">           return <span class="literal">true</span>;</div><div class="line">       &#125;</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> V put(K <span class="built_in">key</span>, V value) &#123;</div><div class="line">       <span class="keyword">return</span> putVal(hash(<span class="built_in">key</span>), <span class="built_in">key</span>, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="keyword">final</span> V putVal(<span class="built_in">int</span> hash, K <span class="built_in">key</span>, V value, <span class="built_in">boolean</span> onlyIfAbsent,<span class="built_in">boolean</span> evict) &#123;</div><div class="line">       Node&lt;K,V&gt;[] tab; </div><div class="line">	Node&lt;K,V&gt; p; </div><div class="line">	<span class="built_in">int</span> n, i;</div><div class="line"></div><div class="line">	判断前面的数组如果为<span class="number">0</span>就进行扩容</div><div class="line">       <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">           n = (tab = resize()).length;</div><div class="line"></div><div class="line">	<span class="comment">//确定当前元素放在哪个数组中</span></div><div class="line">       <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">           tab[i] = newNode(hash, <span class="built_in">key</span>, value, <span class="keyword">null</span>);</div><div class="line">       <span class="keyword">else</span> &#123;</div><div class="line">           Node&lt;K,V&gt; e; </div><div class="line">		K k;</div><div class="line">           <span class="keyword">if</span> (p.hash == hash &amp;&amp;</div><div class="line">               ((k = p.<span class="built_in">key</span>) == <span class="built_in">key</span> || (<span class="built_in">key</span> != <span class="keyword">null</span> &amp;&amp; <span class="built_in">key</span>.equals(k))))</div><div class="line">               e = p;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">               e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, <span class="built_in">key</span>, value);</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">for</span> (<span class="built_in">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">                   <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">                       p.next = newNode(hash, <span class="built_in">key</span>, value, <span class="keyword">null</span>);</div><div class="line">                       <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">                           treeifyBin(tab, hash);</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (e.hash == hash &amp;&amp;</div><div class="line">                       ((k = e.<span class="built_in">key</span>) == <span class="built_in">key</span> || (<span class="built_in">key</span> != <span class="keyword">null</span> &amp;&amp; <span class="built_in">key</span>.equals(k))))</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   p = e;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">               V oldValue = e.value;</div><div class="line">               <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">                   e.value = value;</div><div class="line">               afterNodeAccess(e);</div><div class="line">               <span class="keyword">return</span> oldValue;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       ++modCount;</div><div class="line">       <span class="keyword">if</span> (++<span class="built_in">size</span> &gt; threshold)</div><div class="line">           resize();</div><div class="line">       afterNodeInsertion(evict);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/java基础/">java基础</a></div><div class="post-nav"><a href="/2016/07/26/GitHub入门笔记/" class="pre">GitHub入门笔记</a><a href="/2016/07/21/javaString/" class="next">详解String</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://zw6234336.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志/">日志</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计/">设计</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/java基础/" style="font-size: 15px;">java基础</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/Mysql/" style="font-size: 15px;">Mysql</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/文件存储/" style="font-size: 15px;">文件存储</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/其他/" style="font-size: 15px;">其他</a> <a href="/tags/java-hashmap/" style="font-size: 15px;">java hashmap</a> <a href="/tags/jenkins/" style="font-size: 15px;">jenkins</a> <a href="/tags/eclipse-svn/" style="font-size: 15px;">eclipse-svn</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/业务/" style="font-size: 15px;">业务</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/hexo2github/">hexo搭建github个人主页</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/jetty/">svn</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/JavaNaming/">JAVA实用命名规则</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/HttpClientPool/">org.apache.commons.httpclient学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/demete/">Demeter</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/07/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/30/redWar/">抢红包</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/10/how-hashmap-works-in-java/">How hashmap works in java</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/FastDFS/">FastDFS分布式存储</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/13/SLF4J-manual/">SLF4J日志文档翻译</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">张伟的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>